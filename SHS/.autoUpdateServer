#!/bin/bash

# Nate G's AUS script. (Auto Update Server)
# This script downloads the latest PaperMC build and updates your Paper MC server. It will stop your server, but will not start it up again.
# Licensed under the Apache License 2.0

# CONFIG
MINECRAFT_VERSION="1.21.10"  # Change to your Minecraft version
SERVER_DIR="/home/minecraft"  # Change to your server directory
BACKUP_DIR="/home/minecraft/backup_File_directory"  # Where the program stores backups (leave this alone)
JAR_NAME="paper.jar"  # Name of your server jar file (you can leave this alone)
SCREEN_NAME="minecraft"  # Name of your screen session

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== Nate G's Automatic Update Script (AUS) ===${NC}"

# Getting latest build number
echo "Searching for PaperMC Latest Build Info..."
LATEST_BUILD=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${MINECRAFT_VERSION}" | grep -o '"builds":\[[0-9,]*\]' | grep -o '[0-9]*' | tail -1)

# Error message if build cannot be found
if [ -z "$LATEST_BUILD" ]; then
    echo -e "${RED}Error: Could not fetch latest build number. Check your Minecraft version.${NC}"
    exit 1
fi

echo -e "Latest build: ${GREEN}${LATEST_BUILD}${NC}"

# Download new version
echo "${GREEN}Downloading latest Paper build for your version: ${LATEST_BUILD}${NC}"
DOWNLOAD_URL="https://api.papermc.io/v2/projects/paper/versions/${MINECRAFT_VERSION}/builds/${LATEST_BUILD}/downloads/paper-${MINECRAFT_VERSION}-${LATEST_BUILD}.jar"

curl -o "$SERVER_DIR/$JAR_NAME" "$DOWNLOAD_URL"

if [ $? -eq 0 ]; then
    echo -e "${GREEN}Download successful!${NC}"
else
    echo -e "${RED}Error! Download failed!${NC}"

# Program results   
echo -e "${GREEN}=== Update Complete! Star the github if you enjoyed using this program! ===${NC}"
echo -e "Updated to Paper build ${LATEST_BUILD}. Check out my plugin as well! Linked on my Github page.